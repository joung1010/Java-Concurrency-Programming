## 자바 동시성 프로그래밍
자바에서 쓰레드는 내부적으로는 운영체제의 도움을 받아 작동하게 된다.  
쓰레드 생성되는 시점에 운영체제가 개입을 해 제어하는 방식으로 동작한다.  
### 동작 방식
1. **쓰레드 생성**: 자바에서 쓰레드를 생성하면, JVM은 이 요청을 운영체제에 전달한다. 운영체제는 이를 수행하고, 자바 쓰레드에 대응하는 운영체제 수준의 쓰레드를 생성.
2. **쓰레드 스케줄링과 관리**: 쓰레드의 실행, 스케줄링(언제 어떤 쓰레드가 실행될지 결정하는 과정)은 운영체제의 책임이다. JVM은 운영체제의 스케줄링 정책을 따르며, 운영체제는 사용 가능한 프로세서 자원을 쓰레드에 할당
3. **사용자 수준 쓰레드와 커널 수준 쓰레드**: 일부 운영체제에서는 사용자 수준 쓰레드(운영체제 커널이 관리하지 않는 쓰레드)와 커널 수준 쓰레드(운영체제 커널에 의해 직접 관리되는 쓰레드)를 지원한다. `자바`는 이러한 구분 없이 **투명하게 쓰레드를 관리**하도록 설계되었습니다.
4. **플랫폼 독립성**: 자바의 플랫폼 독립성으로 인해, 동일한 자바 쓰레드 코드가 다양한 운영체제에서 동일하게 작동할 수 있다. 그러나 쓰레드의 성능과 행동은 운영체제에 따라 다를 수 있다.
5. **JVM과 운영체제의 최적화**: 최신 JVM과 운영체제는 쓰레드 성능을 최적화하기 위해 긴밀하게 협력한다. 예를 들어, 가비지 컬렉션, 쓰레드 풀 관리 등은 JVM과 운영체제 간의 효율적인 상호작용을 통해 이루어진다.
  
이처럼 자바의 쓰레드와 운영체제는 긴밀하게 서로 소통하기 때문에 이 쓰레드를 잘 이해하기 위해서는 그 밑단에 흐르는 운영체제에서 동작하는 기본적인 쓰레드 원리 와 작동원리 및 도시성에 대하여 알 필요가 있다.  
즉, 자바쓰레드가 실행되는 시점에 운영체제의 상태와 쓰레드간의 전환이 발생하는 문제에 대한 처리 방법등 이러한 기본적인 흐름에 대한 이해가 필요하다.  
  
# 프로세스 와 쓰레드
| 프로세스 | 쓰레드 |
| --- | --- |
| 운영체제로부터 자원을 할당 받은 작업 단위 | 프로세스가 할당받은 자원을 이용하는 실행 흐름의 단위 |  
## 프로세스
### 프로그램
운영체제에 의해 시스템에 설치되어 있는 파일을 프로그램이라 말한다.  
예를들어 윈도우의 `.exe` 파일이나 Mac의 `.dmg` 파일과 같은 컴퓨터에서 실행할 수 있는 파일을 통칭한다.  
즉 아직 **파일을 실행하지 않는 상태**를 말한다.  
  
### 프로세스
프로그램이 실행하지 않는 파일을 말한다면 이를 **동작시켜서 프로그램이 돌아가고 있는 상태**를 프로세스라고 한다.  
즉, 프로세스는 프로그램의 실제 실행을 의미하며 이를 실행함으로써 프로그램의 **데이터들이 메모리에 올라와 cpu를 할당받고 명령을 수행하고 있는 상태** 이다.  

| 프로그램 | 프로세스 |
| --- | --- |
| 어떤 작업을 하기 위해 실행할 수 있는 파일 | 실행되어 작업중인 컴퓨터 프로그램 |
| 파일이 저장 장치에 있지만 메모리에는 올라가 있지 않은 정적인 상태 | 메모리에 적재되고 CPU 자원을 할당받아 프로그램이 실행되고 있는 상태 |
| 코드 덩어리 | 코드 실행시킨 것 |  
  
## 쓰레드
오늘날 우리가 컴퓨터에서 파일을 다운로드 받으면 다른 작업을 당연하게 할 수 있지만 예전에는 파일을 다운로드 받으면 이 작업이 종료될때까지 기다려야 다음 작업을 할 수 있었다. 그렇다고 동일한 프로그램을 여러개의 프로세스로 만들게 되면 메모리와 CPU의 자원이 중복되게 되는 문제점이 발생한다. 이러한 한계를 극복하고자 나온 개념이 쓰레드이다.  
  
즉, **하나의 프로세스 내에서 동시에 진행되는 작업의 갈래, 흐름의 단위를 말한다.** 하나의 프로세스는 반드시 하나 이상의 스레드를 갖는다.
  
## 프로세스의 메모리 구조
- **코드 영역(Code/ Text)**: 프로그래머가 작성한 프로그램 함수들의 코드가 CPU가 해석 가능한 기계어 형태로 저장
- **데이터 영역(Data)**: 코드가 실행되면서 사용하는 전역 변수나 각종 데이터들이 모여있다. 데이터영역은 .data ,.rodata, .bss 영역으로 세분화 된다.
    - .data: 전역변수, 또는 static 변수 등 프로그램이 사용하는 데이터를 저장
    - .BSS : 초기값 없는 전역 변수, static 변수가 저장
    - .rodata: const 같은 상수 키워드 선언 된 변수나 문자열 상수가 저장
- **스택 영역(Stack):** 지역 변수와 같은 호출한 함수가 종료되면 되돌아올 임시적인 자료를 저장하는 독립적인 공간. Stack은 함수의 호출과 함께 할당되며, 함수의 호출이 완료되면 소멸한다. 만일 stack 영역을 초과하면 stack overflow 에러가 발생한다.
- **힙 영역(Heap):** 생성자, 인스턴스와 같은 동적으로 할당되는 데이터들을 위해 존재하는 공간이다. 사용자에 의해 메모리 공간이 동적으로 할당되고 해제된다.
  
운영 체제는 프로세스마다 위처럼 각각 독립적인 메모리 영역을 할당해 주게 된다. 이때 코드 영역과 데이터 영역은 크기가 정해져 있지만, **스택 영역과 힙영역은 실행 되는 동안 크기가 늘었다가 줄었다가 하는 동적 영역**이다.  
이렇게 프로세스 마다 독립된 메모리 영역이 할당되기 때문에 프로세스 간 영향을 받지 않고 독립적인 작업을 수행 할 수 있다. 기본적으로 프로세스간의 정보 공유가 완전히 불가능한 것은 아닌데 IPC(Inter-Process Communication) , LPC(Local inter-Process Communication), 별도로 공유 메모리를 만들어서 정보를 주고받도록 설정하면 공유가 가능하다.  
  
## 쓰레드의 자원 공유
 쓰레드는 프로세스가 운영체제로부터 할당 받은 자원을 이용하는 실행,흐름 단위로서 하나의 프로세스는 하나 이상의 스레드를 갖는다. 스레드가 여러개 있으면 우리가 브라우저에서 파일을 다운로드 받으면서 동시에 웹서핑을 할 수 있게 해준다.  
이 쓰레드는 **프로세스의 자원을 공유** 하면서 실행 흐름의 일부가 되기때문에 **동시 작업이 가능**한 것이다. 이 프로세스의 자원공유란 프로세스 내에서 각 필요한 스택(함수 호출 시 전달되는 인자, 되돌아갈 주소값, 함수 내에서 선언하는 변수 등을 저장하는 공간)만 할당 받고 코드,데이타,힙 영역을 공유한다.  
이때 스레드 간 메모리 스택 영역에는 서로 접근할 수 없으므로 스레드는 독립적인 실행 흐름을 가질 수 있게되어 독립적인 함수 호출이 가능해 진다.  
  
# CPU
## CPU
CPU (Central Processing Unit)는 컴퓨터의 주요 구성 요소로, **컴퓨터의 모든 명령을 처리**하는 데 필요한 계산 및 제어 작업을 수행합니다. CPU는 **컴퓨터의 '두뇌'**로 간주되며, 모든 프로그램 실행, 데이터 처리, 명령 실행 등을 담당합니다. CPU의 성능은 컴퓨터의 전반적인 속도와 성능에 중요한 영향을 미칩니다.
  
### 멀티 코어와 쓰레드
컴퓨터 부품을 검색해보면 CPU 4코어 12쓰레드, 8코어 4쓰레드 이런 단어를 본적이 있을 것이다. CPU 한개는 여러 코어를 가질 수 있다.  
이 코어는 말그대로 CPU 코어 유닛인데, 명령어를 메모리에서 뽑아 해석하고 실행하는 유닛이 물리적으로 4개가 있으면 4코어, 8개가 있으면 8코어라고 불린다.  
이때 4코어 2쓰레드는 물리적인 코어 하나가 쓰레드 2개 이상을 동시에 실행 가능하다는 의미이고, 운영체제는 8개의 작업(4코어*2쓰레드)을 동시에 처리할 수 있다는 의미이기도 한다. 이를 하이퍼스레딩(Hyper-Threading) 기술이라 말한다.  

# CPU 작업의 병렬성(Parallelism) 과 동시성(Concurrency)
## 동시성
동시성은 둘 이상의 작업이 동시에 실행되는 것을 의미하는데 이는 **CPU가 한번에 많은 일을 처리하는 것**에 중점을 두고 있다. 즉, 많은 작업들을 아주 빠른 시간으로 교체하면서 전체 작업을 수행한다. 예를 들어 1개의 코어가 있고 여러개의 작업이 존재한다면 CPU는 프로세스들을 번걸아가며 조금씩 아주 빠르게 처리함으로써 마치 프로그램이 동시에 실행되는 것처럼 보인다.
이때 작업들을 번갈아가면서 실행하기 때문아 아주 잘게 나누어 조금씩 작업을 수행하고 다음 작업으로 넘어가는 식으로 동작한다. 이렇게 하는 이유는 여러 작업을 동시에 처리하는 것처럼 보이게 만들어 사용자에게 더 빠른 반응성을 제공하기 위해서이다.  
진행중인 작업들을 A -> B -> C -> D -> A 이런식으로 번걸아 바꾸는 작업을 **Context Switching** 이라고 부른다.  
이 도싱성 작업은 처리를 빠르게 하기 위한 목적이 아닌 CPU를 효율적으로 사용하는 것에 더 중점을 두고 있다. 따라서 이 동시성 작업에 대한 처리 방식을 어떤식으로 진행할 것인지 고려해야하며 동시성으로 작업해햐할 수가 CPU 코어 수 보다 많을 경우 해당되며 동시성이 없으면 작업을 순차적으로 진행한다.  
  
## 병렬성
병렬성은 직관적으로 명령어를 메모리에 뽑아 해석하고 실행하는 반도체 유닛인 **코어에 맞춰 여러개의 프로세스, 스레드를 돌려 병렬로 작업을 동시 수행**하는 것을 말한다. 이 병렬성은 **CPU가 동시에 많은 일을 수행하는 것에 중점**을 두고 CPU가 놀지않고 바쁘게 동작한다. 따라서 병렬성은 런타임에 동시에 물리적으로 작업을 실행하는 것이며 여러 컴퓨팅 리소스가 있는 하드웨어가 필요함로 한 개의 코어에서는 절대 병렬성이 구현될 수 없다.  
이 병렬성은 동시성의 하위 개념으로 여러 쓰레드로 작업을 분리하여 그 쓰레드를 CPU에 적절히 분배하여 동시적으로 실행하도록 하는 것이므로 병렬 작업해야할 수가 CPU 코어 수보다 같거나 적을 경우 효율이 가장 좋다.